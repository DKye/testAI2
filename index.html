<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠŸç‡-æ•ˆç‡æ›²çº¿åˆ†æå·¥å…·</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-tertiary: #e8e8e8;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #dddddd;
            --card-shadow: 0 2px 8px rgba(0,0,0,0.1);
            --input-bg: #ffffff;
            --button-bg: #007bff;
            --button-hover: #0056b3;
            --button-text: #ffffff;
            --danger-bg: #dc3545;
            --danger-hover: #c82333;
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #3a3a3a;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --border-color: #444444;
            --card-shadow: 0 2px 8px rgba(0,0,0,0.5);
            --input-bg: #2d2d2d;
            --button-bg: #0d6efd;
            --button-hover: #0b5ed7;
            --button-text: #ffffff;
            --danger-bg: #dc3545;
            --danger-hover: #bb2d3b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft YaHei", sans-serif;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        h1 {
            color: var(--text-primary);
            font-size: 28px;
            margin: 0;
        }

        .theme-toggle {
            background: var(--button-bg);
            color: var(--button-text);
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .theme-toggle:hover {
            background: var(--button-hover);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
        }

        .card h2 {
            margin-bottom: 15px;
            font-size: 20px;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
        }

        .chart-container {
            position: relative;
            height: 500px;
            margin-bottom: 20px;
        }

        .settings-panel {
            max-height: 80vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            font-family: monospace;
        }

        .form-group input[type="checkbox"] {
            margin-right: 8px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .button {
            background: var(--button-bg);
            color: var(--button-text);
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .button:hover {
            background: var(--button-hover);
        }

        .button-small {
            padding: 4px 8px;
            font-size: 12px;
        }

        .button-danger {
            background: var(--danger-bg);
        }

        .button-danger:hover {
            background: var(--danger-hover);
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .curve-item {
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            background: var(--bg-secondary);
        }

        .curve-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .curve-header input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }

        .curve-header input[type="text"] {
            flex: 1;
            min-width: 100px;
        }

        .curve-header input[type="color"] {
            width: 50px;
            height: 30px;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 13px;
        }

        .data-table th,
        .data-table td {
            padding: 6px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            background: var(--bg-tertiary);
            font-weight: 600;
        }

        .data-table td {
            background: var(--input-bg);
        }

        .instructions {
            background: var(--bg-primary);
            padding: 15px;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
        }

        .instructions h3 {
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .instructions ul {
            margin-left: 20px;
        }

        .instructions li {
            margin-bottom: 5px;
            color: var(--text-secondary);
        }

        .collapsible {
            cursor: pointer;
            user-select: none;
        }

        .collapsible::before {
            content: "â–¼ ";
            display: inline-block;
            transition: transform 0.3s;
        }

        .collapsible.collapsed::before {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .collapsible-content.collapsed {
            max-height: 0;
        }

        .export-section {
            background: var(--bg-secondary);
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .point-input {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 5px;
            align-items: end;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>åŠŸç‡-æ•ˆç‡æ›²çº¿åˆ†æå·¥å…·</h1>
            <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ“ åˆ‡æ¢ä¸»é¢˜</button>
        </div>

        <div class="instructions">
            <h3 class="collapsible" onclick="toggleCollapsible(this)">ä½¿ç”¨è¯´æ˜</h3>
            <div class="collapsible-content">
                <ul>
                    <li><strong>å¤šæ›²çº¿ç®¡ç†ï¼š</strong>æœ€å¤šæ”¯æŒ5æ¡æ›²çº¿ï¼Œæ¯æ¡æ›²çº¿å¯ç‹¬ç«‹è®¾ç½®åç§°ã€é¢œè‰²ã€æ˜¾ç¤º/éšè—</li>
                    <li><strong>æ•°æ®è¾“å…¥ï¼š</strong>æ”¯æŒæ‰¹é‡ç²˜è´´ï¼ˆæ ¼å¼ï¼šåŠŸç‡ æ•ˆç‡ï¼Œæ¯è¡Œä¸€ç»„ï¼‰æˆ–é€ç‚¹æ·»åŠ </li>
                    <li><strong>æ‰¹é‡ç²˜è´´æ ¼å¼ï¼š</strong>æ”¯æŒç©ºæ ¼ã€åˆ¶è¡¨ç¬¦æˆ–é€—å·åˆ†éš”ï¼Œå¦‚"10 95.5"æˆ–"10,95.5"</li>
                    <li><strong>å›¾è¡¨è®¾ç½®ï¼š</strong>å¯è‡ªå®šä¹‰æ ‡é¢˜ã€åæ ‡è½´æ ‡ç­¾ã€èŒƒå›´ã€å¹³æ»‘æ›²çº¿ã€åŒºåŸŸå¡«å……ç­‰</li>
                    <li><strong>å‚è€ƒçº¿ï¼š</strong>å¯æ·»åŠ æ•ˆç‡å‚è€ƒçº¿ï¼Œå¦‚97.5%</li>
                    <li><strong>å¯¼å‡ºåŠŸèƒ½ï¼š</strong>æ”¯æŒå¯¼å‡ºPNGã€SVGå›¾ç‰‡åŠJSONé…ç½®æ–‡ä»¶</li>
                    <li><strong>æ•°æ®æ¢å¤ï¼š</strong>é…ç½®è‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°ï¼Œåˆ·æ–°é¡µé¢åå¯æ¢å¤</li>
                </ul>
            </div>
        </div>

        <div class="main-content">
            <div class="chart-section">
                <div class="card">
                    <h2>åŠŸç‡-æ•ˆç‡æ›²çº¿å›¾</h2>
                    <div class="chart-container">
                        <canvas id="powerEfficiencyChart"></canvas>
                    </div>
                    <div class="button-group">
                        <button class="button" onclick="exportPNG()">ğŸ“Š å¯¼å‡ºPNG</button>
                        <button class="button" onclick="exportSVG()">ğŸ“ˆ å¯¼å‡ºSVG</button>
                        <button class="button" onclick="exportConfig()">ğŸ’¾ å¯¼å‡ºé…ç½®JSON</button>
                        <div class="file-input-wrapper">
                            <button class="button">ğŸ“‚ å¯¼å…¥é…ç½®JSON</button>
                            <input type="file" id="importConfig" accept=".json" onchange="importConfig(event)">
                        </div>
                        <button class="button" onclick="loadFromLocalStorage()">ğŸ”„ æ¢å¤ä¸Šæ¬¡é…ç½®</button>
                    </div>
                </div>

                <div class="card">
                    <h2>å…¨å±€è®¾ç½®</h2>
                    <div class="form-group">
                        <label>å›¾è¡¨ä¸»æ ‡é¢˜</label>
                        <input type="text" id="chartTitle" value="åŠŸç‡-æ•ˆç‡ç‰¹æ€§æ›²çº¿" onchange="updateChart()">
                    </div>
                    <div class="form-group">
                        <label>Xè½´æ ‡é¢˜</label>
                        <input type="text" id="xAxisLabel" value="DCè¾“å…¥åŠŸç‡ (kW)" onchange="updateChart()">
                    </div>
                    <div class="form-group">
                        <label>Yè½´æ ‡é¢˜</label>
                        <input type="text" id="yAxisLabel" value="æ•ˆç‡ (%)" onchange="updateChart()">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Xè½´æœ€å°å€¼</label>
                            <input type="number" id="xMin" placeholder="è‡ªåŠ¨" onchange="updateChart()">
                        </div>
                        <div class="form-group">
                            <label>Xè½´æœ€å¤§å€¼</label>
                            <input type="number" id="xMax" placeholder="è‡ªåŠ¨" onchange="updateChart()">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Yè½´æœ€å°å€¼</label>
                            <input type="number" id="yMin" value="0" onchange="updateChart()">
                        </div>
                        <div class="form-group">
                            <label>Yè½´æœ€å¤§å€¼</label>
                            <input type="number" id="yMax" value="100" onchange="updateChart()">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="smoothCurves" onchange="updateChart()">
                            å¹³æ»‘æ›²çº¿
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="fillArea" onchange="updateChart()">
                            åŒºåŸŸå¡«å……
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="showPoints" checked onchange="updateChart()">
                            æ˜¾ç¤ºæ•°æ®ç‚¹
                        </label>
                    </div>
                    <div class="form-group">
                        <label>æ•ˆç‡å‚è€ƒçº¿ (%)</label>
                        <input type="number" id="referenceLine" placeholder="ä¾‹å¦‚: 97.5" step="0.1" onchange="updateChart()">
                    </div>
                </div>
            </div>

            <div class="settings-panel card">
                <h2>æ›²çº¿æ•°æ®ç®¡ç†</h2>
                <div id="curvesContainer"></div>
                <button class="button" onclick="addCurve()" id="addCurveBtn">â• æ·»åŠ æ›²çº¿</button>
            </div>
        </div>
    </div>

    <script>
        // æ•°æ®ç»“æ„
        let curves = [];
        let chart = null;
        const MAX_CURVES = 5;
        const DEFAULT_COLORS = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'];

        // åˆå§‹åŒ–
        function init() {
            // å°è¯•ä»localStorageåŠ è½½
            const saved = localStorage.getItem('powerEfficiencyConfig');
            if (saved) {
                try {
                    const config = JSON.parse(saved);
                    loadConfiguration(config);
                    return;
                } catch (e) {
                    console.error('Failed to load from localStorage:', e);
                }
            }
            
            // é»˜è®¤åˆ›å»ºç¬¬ä¸€æ¡æ›²çº¿å¹¶å¡«å……ç¤ºä¾‹æ•°æ®
            addCurve();
            curves[0].label = 'ç¤ºä¾‹æ›²çº¿';
            curves[0].visible = true;
            curves[0].data = [
                { x: 10, y: 92.5 },
                { x: 20, y: 95.2 },
                { x: 30, y: 96.8 },
                { x: 40, y: 97.5 },
                { x: 50, y: 97.8 },
                { x: 60, y: 97.9 },
                { x: 70, y: 97.8 },
                { x: 80, y: 97.5 },
                { x: 90, y: 97.0 },
                { x: 100, y: 96.2 }
            ];
            renderCurves();
            initChart();
        }

        // æ·»åŠ æ›²çº¿
        function addCurve() {
            if (curves.length >= MAX_CURVES) {
                alert(`æœ€å¤šåªèƒ½æ·»åŠ ${MAX_CURVES}æ¡æ›²çº¿`);
                return;
            }
            
            curves.push({
                label: `æ›²çº¿ ${curves.length + 1}`,
                color: DEFAULT_COLORS[curves.length % DEFAULT_COLORS.length],
                visible: false,
                data: []
            });
            
            renderCurves();
            updateChart();
        }

        // æ¸²æŸ“æ›²çº¿åˆ—è¡¨
        function renderCurves() {
            const container = document.getElementById('curvesContainer');
            container.innerHTML = '';
            
            curves.forEach((curve, index) => {
                const curveDiv = document.createElement('div');
                curveDiv.className = 'curve-item';
                curveDiv.innerHTML = `
                    <div class="curve-header">
                        <input type="checkbox" ${curve.visible ? 'checked' : ''} 
                               onchange="toggleCurveVisibility(${index}, this.checked)">
                        <input type="text" value="${curve.label}" 
                               onchange="updateCurveLabel(${index}, this.value)">
                        <input type="color" value="${curve.color}" 
                               onchange="updateCurveColor(${index}, this.value)">
                        <button class="button button-small button-danger" 
                                onclick="removeCurve(${index})">åˆ é™¤</button>
                    </div>
                    
                    <h4 class="collapsible" onclick="toggleCollapsible(this)">æ‰¹é‡ç²˜è´´æ•°æ®</h4>
                    <div class="collapsible-content">
                        <div class="form-group">
                            <textarea rows="4" id="bulkData${index}" 
                                      placeholder="æ¯è¡Œè¾“å…¥ï¼šåŠŸç‡ æ•ˆç‡&#10;ä¾‹å¦‚ï¼š&#10;10 92.5&#10;20 95.2&#10;30 96.8"></textarea>
                        </div>
                        <button class="button button-small" onclick="parseBulkData(${index})">è§£æå¹¶æ·»åŠ </button>
                    </div>
                    
                    <h4 class="collapsible" onclick="toggleCollapsible(this)">é€ç‚¹æ·»åŠ </h4>
                    <div class="collapsible-content">
                        <div class="point-input">
                            <div class="form-group">
                                <label>åŠŸç‡ (kW)</label>
                                <input type="number" id="power${index}" step="0.1">
                            </div>
                            <div class="form-group">
                                <label>æ•ˆç‡ (%)</label>
                                <input type="number" id="efficiency${index}" step="0.1">
                            </div>
                            <button class="button button-small" onclick="addPoint(${index})">æ·»åŠ ç‚¹</button>
                        </div>
                    </div>
                    
                    <h4 class="collapsible" onclick="toggleCollapsible(this)">æ•°æ®è¡¨ (${curve.data.length} ç‚¹)</h4>
                    <div class="collapsible-content">
                        ${renderDataTable(index, curve.data)}
                        <button class="button button-small button-danger" 
                                onclick="clearCurveData(${index})">æ¸…ç©ºæ•°æ®</button>
                    </div>
                `;
                container.appendChild(curveDiv);
            });
            
            document.getElementById('addCurveBtn').style.display = 
                curves.length >= MAX_CURVES ? 'none' : 'block';
        }

        // æ¸²æŸ“æ•°æ®è¡¨
        function renderDataTable(curveIndex, data) {
            if (data.length === 0) {
                return '<p style="color: var(--text-secondary); margin: 10px 0;">æš‚æ— æ•°æ®</p>';
            }
            
            let html = '<table class="data-table"><thead><tr><th>åºå·</th><th>åŠŸç‡(kW)</th><th>æ•ˆç‡(%)</th><th>æ“ä½œ</th></tr></thead><tbody>';
            data.forEach((point, pointIndex) => {
                html += `<tr>
                    <td>${pointIndex + 1}</td>
                    <td>${point.x}</td>
                    <td>${point.y}</td>
                    <td><button class="button button-small button-danger" 
                                onclick="removePoint(${curveIndex}, ${pointIndex})">åˆ é™¤</button></td>
                </tr>`;
            });
            html += '</tbody></table>';
            return html;
        }

        // è§£ææ‰¹é‡æ•°æ®
        function parseBulkData(curveIndex) {
            const textarea = document.getElementById(`bulkData${curveIndex}`);
            const lines = textarea.value.split('\n');
            let added = 0;
            
            lines.forEach(line => {
                line = line.trim();
                if (!line || line.startsWith('#') || line.startsWith('//')) return;
                
                // æ”¯æŒç©ºæ ¼ã€åˆ¶è¡¨ç¬¦ã€é€—å·åˆ†éš”
                const parts = line.split(/[\s,]+/).filter(p => p);
                if (parts.length >= 2) {
                    const x = parseFloat(parts[0]);
                    const y = parseFloat(parts[1]);
                    if (!isNaN(x) && !isNaN(y)) {
                        curves[curveIndex].data.push({ x, y });
                        added++;
                    }
                }
            });
            
            // æŒ‰xæ’åº
            curves[curveIndex].data.sort((a, b) => a.x - b.x);
            
            textarea.value = '';
            alert(`æˆåŠŸæ·»åŠ  ${added} ä¸ªæ•°æ®ç‚¹`);
            renderCurves();
            updateChart();
        }

        // æ·»åŠ å•ä¸ªæ•°æ®ç‚¹
        function addPoint(curveIndex) {
            const power = parseFloat(document.getElementById(`power${curveIndex}`).value);
            const efficiency = parseFloat(document.getElementById(`efficiency${curveIndex}`).value);
            
            if (isNaN(power) || isNaN(efficiency)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å€¼');
                return;
            }
            
            curves[curveIndex].data.push({ x: power, y: efficiency });
            curves[curveIndex].data.sort((a, b) => a.x - b.x);
            
            document.getElementById(`power${curveIndex}`).value = '';
            document.getElementById(`efficiency${curveIndex}`).value = '';
            
            renderCurves();
            updateChart();
        }

        // åˆ é™¤æ•°æ®ç‚¹
        function removePoint(curveIndex, pointIndex) {
            curves[curveIndex].data.splice(pointIndex, 1);
            renderCurves();
            updateChart();
        }

        // æ¸…ç©ºæ›²çº¿æ•°æ®
        function clearCurveData(curveIndex) {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºè¯¥æ›²çº¿çš„æ‰€æœ‰æ•°æ®å—ï¼Ÿ')) {
                curves[curveIndex].data = [];
                renderCurves();
                updateChart();
            }
        }

        // åˆ é™¤æ›²çº¿
        function removeCurve(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¯¥æ›²çº¿å—ï¼Ÿ')) {
                curves.splice(index, 1);
                renderCurves();
                updateChart();
            }
        }

        // æ›´æ–°æ›²çº¿å±æ€§
        function toggleCurveVisibility(index, visible) {
            curves[index].visible = visible;
            updateChart();
        }

        function updateCurveLabel(index, label) {
            curves[index].label = label;
            updateChart();
        }

        function updateCurveColor(index, color) {
            curves[index].color = color;
            updateChart();
        }

        // åˆå§‹åŒ–å›¾è¡¨
        function initChart() {
            const ctx = document.getElementById('powerEfficiencyChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'åŠŸç‡-æ•ˆç‡ç‰¹æ€§æ›²çº¿',
                            font: { size: 18 },
                            color: getComputedStyle(document.body).getPropertyValue('--text-primary')
                        },
                        legend: {
                            display: true,
                            labels: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-primary')
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: åŠŸç‡=${context.parsed.x}kW, æ•ˆç‡=${context.parsed.y}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: 'DCè¾“å…¥åŠŸç‡ (kW)',
                                color: getComputedStyle(document.body).getPropertyValue('--text-primary')
                            },
                            ticks: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-secondary')
                            },
                            grid: {
                                color: getComputedStyle(document.body).getPropertyValue('--border-color')
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'æ•ˆç‡ (%)',
                                color: getComputedStyle(document.body).getPropertyValue('--text-primary')
                            },
                            min: 0,
                            max: 100,
                            ticks: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-secondary')
                            },
                            grid: {
                                color: getComputedStyle(document.body).getPropertyValue('--border-color')
                            }
                        }
                    }
                }
            });
            
            updateChart();
        }

        // æ›´æ–°å›¾è¡¨
        function updateChart() {
            if (!chart) return;
            
            const smoothCurves = document.getElementById('smoothCurves').checked;
            const fillArea = document.getElementById('fillArea').checked;
            const showPoints = document.getElementById('showPoints').checked;
            const referenceLine = parseFloat(document.getElementById('referenceLine').value);
            
            // å‡†å¤‡æ•°æ®é›†
            const datasets = curves
                .filter(curve => curve.visible)
                .map(curve => ({
                    label: curve.label,
                    data: curve.data,
                    borderColor: curve.color,
                    backgroundColor: fillArea ? curve.color + '40' : curve.color,
                    fill: fillArea,
                    tension: smoothCurves ? 0.4 : 0,
                    cubicInterpolationMode: smoothCurves ? 'monotone' : 'default',
                    pointRadius: showPoints ? 4 : 0,
                    pointHoverRadius: 6
                }));
            
            // æ·»åŠ å‚è€ƒçº¿
            if (!isNaN(referenceLine)) {
                const xValues = curves
                    .filter(c => c.visible && c.data.length > 0)
                    .flatMap(c => c.data.map(d => d.x));
                
                if (xValues.length > 0) {
                    const minX = Math.min(...xValues);
                    const maxX = Math.max(...xValues);
                    
                    datasets.push({
                        label: `å‚è€ƒçº¿ ${referenceLine}%`,
                        data: [{ x: minX, y: referenceLine }, { x: maxX, y: referenceLine }],
                        borderColor: '#FF0000',
                        borderDash: [5, 5],
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 0
                    });
                }
            }
            
            chart.data.datasets = datasets;
            
            // æ›´æ–°æ ‡é¢˜å’Œè½´æ ‡ç­¾
            chart.options.plugins.title.text = document.getElementById('chartTitle').value;
            chart.options.scales.x.title.text = document.getElementById('xAxisLabel').value;
            chart.options.scales.y.title.text = document.getElementById('yAxisLabel').value;
            
            // æ›´æ–°è½´èŒƒå›´
            const xMin = document.getElementById('xMin').value;
            const xMax = document.getElementById('xMax').value;
            const yMin = document.getElementById('yMin').value;
            const yMax = document.getElementById('yMax').value;
            
            chart.options.scales.x.min = xMin ? parseFloat(xMin) : undefined;
            chart.options.scales.x.max = xMax ? parseFloat(xMax) : undefined;
            chart.options.scales.y.min = yMin ? parseFloat(yMin) : undefined;
            chart.options.scales.y.max = yMax ? parseFloat(yMax) : undefined;
            
            // æ›´æ–°é¢œè‰²ï¼ˆä¸»é¢˜åˆ‡æ¢ï¼‰
            const textColor = getComputedStyle(document.body).getPropertyValue('--text-primary').trim();
            const secondaryColor = getComputedStyle(document.body).getPropertyValue('--text-secondary').trim();
            const borderColor = getComputedStyle(document.body).getPropertyValue('--border-color').trim();
            
            chart.options.plugins.title.color = textColor;
            chart.options.plugins.legend.labels.color = textColor;
            chart.options.scales.x.title.color = textColor;
            chart.options.scales.y.title.color = textColor;
            chart.options.scales.x.ticks.color = secondaryColor;
            chart.options.scales.y.ticks.color = secondaryColor;
            chart.options.scales.x.grid.color = borderColor;
            chart.options.scales.y.grid.color = borderColor;
            
            chart.update();
            
            // è‡ªåŠ¨ä¿å­˜åˆ°localStorage
            saveToLocalStorage();
        }

        // å¯¼å‡ºPNG
        function exportPNG() {
            const link = document.createElement('a');
            link.download = 'power-efficiency-curve.png';
            link.href = chart.toBase64Image();
            link.click();
        }

        // å¯¼å‡ºSVG
        function exportSVG() {
            const canvas = document.getElementById('powerEfficiencyChart');
            const ctx = canvas.getContext('2d');
            
            // åˆ›å»ºSVG
            const svgNS = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(svgNS, "svg");
            svg.setAttribute("width", canvas.width);
            svg.setAttribute("height", canvas.height);
            svg.setAttribute("xmlns", svgNS);
            
            // åµŒå…¥å›¾åƒ
            const image = document.createElementNS(svgNS, "image");
            image.setAttribute("width", canvas.width);
            image.setAttribute("height", canvas.height);
            image.setAttributeNS("http://www.w3.org/1999/xlink", "href", canvas.toDataURL("image/png"));
            svg.appendChild(image);
            
            // ä¸‹è½½
            const svgData = new XMLSerializer().serializeToString(svg);
            const svgBlob = new Blob([svgData], { type: "image/svg+xml;charset=utf-8" });
            const svgUrl = URL.createObjectURL(svgBlob);
            const link = document.createElement("a");
            link.href = svgUrl;
            link.download = "power-efficiency-curve.svg";
            link.click();
            URL.revokeObjectURL(svgUrl);
        }

        // å¯¼å‡ºé…ç½®
        function exportConfig() {
            const config = getCurrentConfiguration();
            const json = JSON.stringify(config, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'power-efficiency-config.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        // å¯¼å…¥é…ç½®
        function importConfig(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const config = JSON.parse(e.target.result);
                    loadConfiguration(config);
                    alert('é…ç½®å¯¼å…¥æˆåŠŸï¼');
                } catch (error) {
                    alert('é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼š' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // è·å–å½“å‰é…ç½®
        function getCurrentConfiguration() {
            return {
                curves: curves,
                settings: {
                    title: document.getElementById('chartTitle').value,
                    xAxisLabel: document.getElementById('xAxisLabel').value,
                    yAxisLabel: document.getElementById('yAxisLabel').value,
                    xMin: document.getElementById('xMin').value,
                    xMax: document.getElementById('xMax').value,
                    yMin: document.getElementById('yMin').value,
                    yMax: document.getElementById('yMax').value,
                    smoothCurves: document.getElementById('smoothCurves').checked,
                    fillArea: document.getElementById('fillArea').checked,
                    showPoints: document.getElementById('showPoints').checked,
                    referenceLine: document.getElementById('referenceLine').value
                }
            };
        }

        // åŠ è½½é…ç½®
        function loadConfiguration(config) {
            curves = config.curves || [];
            
            if (config.settings) {
                document.getElementById('chartTitle').value = config.settings.title || 'åŠŸç‡-æ•ˆç‡ç‰¹æ€§æ›²çº¿';
                document.getElementById('xAxisLabel').value = config.settings.xAxisLabel || 'DCè¾“å…¥åŠŸç‡ (kW)';
                document.getElementById('yAxisLabel').value = config.settings.yAxisLabel || 'æ•ˆç‡ (%)';
                document.getElementById('xMin').value = config.settings.xMin || '';
                document.getElementById('xMax').value = config.settings.xMax || '';
                document.getElementById('yMin').value = config.settings.yMin || '0';
                document.getElementById('yMax').value = config.settings.yMax || '100';
                document.getElementById('smoothCurves').checked = config.settings.smoothCurves || false;
                document.getElementById('fillArea').checked = config.settings.fillArea || false;
                document.getElementById('showPoints').checked = config.settings.showPoints !== undefined ? config.settings.showPoints : true;
                document.getElementById('referenceLine').value = config.settings.referenceLine || '';
            }
            
            renderCurves();
            if (!chart) {
                initChart();
            } else {
                updateChart();
            }
        }

        // ä¿å­˜åˆ°localStorage
        function saveToLocalStorage() {
            try {
                const config = getCurrentConfiguration();
                localStorage.setItem('powerEfficiencyConfig', JSON.stringify(config));
            } catch (e) {
                console.error('Failed to save to localStorage:', e);
            }
        }

        // ä»localStorageåŠ è½½
        function loadFromLocalStorage() {
            const saved = localStorage.getItem('powerEfficiencyConfig');
            if (saved) {
                try {
                    const config = JSON.parse(saved);
                    loadConfiguration(config);
                    alert('é…ç½®æ¢å¤æˆåŠŸï¼');
                } catch (e) {
                    alert('é…ç½®æ¢å¤å¤±è´¥ï¼š' + e.message);
                }
            } else {
                alert('æ²¡æœ‰æ‰¾åˆ°ä¿å­˜çš„é…ç½®');
            }
        }

        // ä¸»é¢˜åˆ‡æ¢
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // æ›´æ–°å›¾è¡¨é¢œè‰²
            if (chart) {
                updateChart();
            }
        }

        // æŠ˜å åŠŸèƒ½
        function toggleCollapsible(element) {
            element.classList.toggle('collapsed');
            const content = element.nextElementSibling;
            if (content && content.classList.contains('collapsible-content')) {
                content.classList.toggle('collapsed');
            }
        }

        // åˆå§‹åŒ–ä¸»é¢˜
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', function() {
            initTheme();
            init();
        });
    </script>
</body>
</html>
